---
title: 'Dimensions'
subtitle: 'Welcome to #30DayMapChallenge 2025 day 6'
date: '2025-11-06'
image: 'day6_dimensions.png'
image-alt: ''
description: ''
output: html_document
execute: 
   eval: false
---

## Overview

This challenge is all about showing the dimension ,

we will process life expectancy at birth data from the IHME GBD 2021 **Global Burden of Disease Study 2021 (GBD 2021) Mortality and Life Expectancy Forecasts 2022-2050** dataset. 

source: <https://ghdx.healthdata.org/record/ihme-data/global-life-expectancy-all-cause-mortality-and-cause-specific-mortality-forecasts-2022-2050> you'll need to login for accessing the data.

### Load Libraries and Data

```{r}
library(tidyverse)
library(stringr)
library(readxl)
library(sf)
library(ggspatial)
library(rnaturalearth)
library(cowplot)
```



```{r}
raw_le2022 <- read_excel("data/IHME_GBD_2021_MORT_LE_FORECASTS_2022_2050_TABLES_0/le.XLSX",skip = 1)
head(raw_le2022)
```

### Reference scenario life expectancy at birth 2022 

#### Female le data

```{r}
female_le2022 <- raw_le2022$`Reference scenario life expectancy at birth` %>%
  str_replace_all("·", ".") %>%     
  str_extract_all("\\d+\\.?\\d*", simplify = TRUE)
```


#### Locations
```{r}
location_name <- raw_le2022$...1
```

#### Build data frame

```{r}
female_le2022 <- data.frame(location_name,female_le2022) %>%
  select(location_name, le = X1) %>%
  mutate(le = as.numeric(le),
         sex="female") %>%
  drop_na()

female_le2022
```

#### Male le data

```{r}
male_le2022 <- raw_le2022$...5 %>%
  str_replace_all("·", ".") %>%     
  str_extract_all("\\d+\\.?\\d*", simplify = TRUE)
```

```{r}
male_le2022 <- data.frame(location_name,male_le2022) %>%
  select(location_name, le = X1) %>%
  mutate(le = as.numeric(le),
         sex="male") %>%
  drop_na()

male_le2022
```

### Combine female and male le

```{r}
le2022_data <- bind_rows(female_le2022,male_le2022) %>%
  group_by(location_name) %>%
  reframe(le_avg2022=round(mean(le)))%>%
  distinct()

le2022_data%>%head
```



#### HALE data

```{r}
raw_le_hale2022 <- read_excel("data/IHME_GBD_2021_MORT_LE_FORECASTS_2022_2050_TABLES_0/le_hale.XLSX")
head(raw_le_hale2022)
```

```{r}
location_name <- raw_le_hale2022$`Supplemental Results Table S2. Life expectancy and healthy life expectancy (HALE) in 2022 and 2050 (reference scenario) by location for both sexes. Estimates are listed as means with 95% uncertainty intervals in parentheses. Highlighted rows indicate region and super region results from the GBD location hierarchy.`
```


```{r}
hale2022 <- raw_le_hale2022$...5%>%
  str_replace_all("·", ".") %>%      
  str_extract_all("\\d+\\.?\\d*", simplify = TRUE)
```

```{r}
hale2022 <- data.frame(location_name,hale2022) %>%
  select(location_name, hale = X1) %>%
  mutate(hale = as.numeric(hale)) %>%
  drop_na()%>%
  distinct()

```


#### From results healthdata website yll and yld by age standardized
```{r}
yll_yld2022_raw <- hmsidwR::getunz("https://dl.healthdata.org:443/gbd-api-2023-public/7bae287bc4f06482be6332f797f3ebc2_files/IHME-GBD_2023_DATA-7bae287b-1.zip")

yll_yld2022 <- yll_yld2022_raw[[1]] %>% 
  select(location_name=location,
         measure,val)
```


```{r}
yld2022_data <- yll_yld2022%>%
  filter(measure=="YLDs (Years Lived with Disability)")%>%
  rename(yld=val)%>%
  select(-measure) %>%
  distinct()
yll2022_data <- yll_yld2022%>%
  filter(measure=="YLLs (Years of Life Lost)")%>%
  rename(yll=val)%>%
  select(-measure) %>%
  distinct()
  
yll_yld2022_data<- merge(yld2022_data,yll2022_data)
```


### Combine all data

```{r}
index_data2022 <- le2022_data %>%
  left_join(hale2022, by="location_name") %>%
  left_join(yll_yld2022_data ,by="location_name") %>%
  drop_na()
```



$$
health_dim_index = (LE_scaled + HALE_scaled + (1 - YLL_scaled) + (1 - YLD_scaled)) / 4
$$

```{r}
dimension_index <- index_data2022 %>%
  mutate(across(where(is.numeric), ~ as.numeric(scale(.x, center = F)),
                .names = "{.col}_scaled")) %>%
  mutate(dimension_index = round((le_avg2022_scaled + hale_scaled + (1-yll_scaled) + (1-yld_scaled))/4,2),
         .after=location_name) 

dimension_index
```


```{r}
library(hmsidwR)
data("idDALY_map_data")
```

```{r}
location_name <- idDALY_map_data$location_name
geometry <- idDALY_map_data$geometry

map_data <- data.frame(location_name,geometry) %>%
  right_join(dimension_index,by="location_name")
```

```{r}
main_map <- ggplot() +
  geom_sf(data = idDALY_map_data) +
  geom_sf(data = map_data, aes(fill=dimension_index,geometry=geometry))+
  ggthemes::scale_fill_continuous_tableau(palette = "Green-Gold") +
  # add a dimension scale
    annotation_scale(
    location = "bl",      # bottom left corner
    width_hint = 0.1,     # relative width of scale bar
    text_cex = 0.4,       # text size
    line_width = 0.3,     # bar line thickness
    style = "bar"         # "ticks" for tick marks, "bar" for solid bar
  ) +
  annotation_north_arrow(
    location = "tl",      # top left corner
    which_north = "true",
    style = north_arrow_fancy_orienteering,
    height = unit(0.5, "cm"),
    width = unit(0.5, "cm")
  ) +
  theme_minimal() +
  labs(
    title = "",
    caption = "Data: IHME and {hmsidwR} | Visualization: Federica Gazzelloni",
    fill="Health Dimension Index"
  ) +
  theme(
    panel.background = element_rect(fill = "aliceblue"),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank()
  )
  
main_map
```


```{r}
# --- Main map (e.g. Europe or world) ---
world <- ne_countries(scale = "medium", returnclass = "sf")
```



```{r}
# --- Little map: Central Africa ---
central_africa <- ggplot(data = world %>%
                           filter(admin=="Central African Republic")) +
  geom_sf(fill = "gold", color = "white") +
  coord_sf() +
  theme_void()

# --- Combine using cowplot ---
final_map <- ggdraw() +
  draw_plot(main_map) +
  draw_plot(central_africa, x = 0.65, y = 0.05, width = 0.25, height = 0.25)

final_map
```

```{r}
ggsave("day6_dimensions.png", plot = final_map, width = 6, height = 4, dpi = 300)
```

